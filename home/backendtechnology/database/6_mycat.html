<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mycat</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.a0ada997.css" as="style"><link rel="preload" href="/assets/js/app.a8d644b6.js" as="script"><link rel="preload" href="/assets/js/2.b0571e25.js" as="script"><link rel="preload" href="/assets/js/39.bbf6207d.js" as="script"><link rel="prefetch" href="/assets/js/10.c8889642.js"><link rel="prefetch" href="/assets/js/100.51a741fb.js"><link rel="prefetch" href="/assets/js/101.d9dbfe05.js"><link rel="prefetch" href="/assets/js/102.52466a3b.js"><link rel="prefetch" href="/assets/js/103.3cf394c6.js"><link rel="prefetch" href="/assets/js/104.90d3018b.js"><link rel="prefetch" href="/assets/js/105.dd9bdeef.js"><link rel="prefetch" href="/assets/js/106.6bda79d0.js"><link rel="prefetch" href="/assets/js/107.ef743f0b.js"><link rel="prefetch" href="/assets/js/108.fa92013e.js"><link rel="prefetch" href="/assets/js/109.50afa695.js"><link rel="prefetch" href="/assets/js/11.e31c3ea5.js"><link rel="prefetch" href="/assets/js/110.aad632dd.js"><link rel="prefetch" href="/assets/js/111.499096ad.js"><link rel="prefetch" href="/assets/js/112.6069b48f.js"><link rel="prefetch" href="/assets/js/113.b8841596.js"><link rel="prefetch" href="/assets/js/114.23496351.js"><link rel="prefetch" href="/assets/js/115.e08ac3c1.js"><link rel="prefetch" href="/assets/js/116.760ebdb3.js"><link rel="prefetch" href="/assets/js/117.f226c0c1.js"><link rel="prefetch" href="/assets/js/118.65289b19.js"><link rel="prefetch" href="/assets/js/119.e3cf777f.js"><link rel="prefetch" href="/assets/js/12.78a1ab5b.js"><link rel="prefetch" href="/assets/js/120.7760e751.js"><link rel="prefetch" href="/assets/js/121.05ec49dd.js"><link rel="prefetch" href="/assets/js/122.688774b7.js"><link rel="prefetch" href="/assets/js/123.06bf7f11.js"><link rel="prefetch" href="/assets/js/124.62bfda58.js"><link rel="prefetch" href="/assets/js/125.eda5b500.js"><link rel="prefetch" href="/assets/js/126.1b39c0b0.js"><link rel="prefetch" href="/assets/js/127.65be59e4.js"><link rel="prefetch" href="/assets/js/128.25fbb5dc.js"><link rel="prefetch" href="/assets/js/129.cd5e2b4b.js"><link rel="prefetch" href="/assets/js/13.6a543448.js"><link rel="prefetch" href="/assets/js/130.fcc93329.js"><link rel="prefetch" href="/assets/js/131.6d7c37d1.js"><link rel="prefetch" href="/assets/js/132.09cf25fb.js"><link rel="prefetch" href="/assets/js/133.583d15f0.js"><link rel="prefetch" href="/assets/js/134.7b72ef87.js"><link rel="prefetch" href="/assets/js/135.733d2857.js"><link rel="prefetch" href="/assets/js/136.b8649b26.js"><link rel="prefetch" href="/assets/js/137.e71138fa.js"><link rel="prefetch" href="/assets/js/138.95b4f55f.js"><link rel="prefetch" href="/assets/js/139.c09e22b6.js"><link rel="prefetch" href="/assets/js/14.819689ab.js"><link rel="prefetch" href="/assets/js/140.71186b46.js"><link rel="prefetch" href="/assets/js/141.5bb51b5a.js"><link rel="prefetch" href="/assets/js/142.94804f8e.js"><link rel="prefetch" href="/assets/js/143.7191f64e.js"><link rel="prefetch" href="/assets/js/144.d2957568.js"><link rel="prefetch" href="/assets/js/145.651e0adf.js"><link rel="prefetch" href="/assets/js/146.d0a83694.js"><link rel="prefetch" href="/assets/js/147.fc4d286f.js"><link rel="prefetch" href="/assets/js/148.410aec93.js"><link rel="prefetch" href="/assets/js/149.a453f4de.js"><link rel="prefetch" href="/assets/js/15.5bc49d67.js"><link rel="prefetch" href="/assets/js/150.77f0ea12.js"><link rel="prefetch" href="/assets/js/151.c808f32e.js"><link rel="prefetch" href="/assets/js/152.22e5d574.js"><link rel="prefetch" href="/assets/js/153.bc4da283.js"><link rel="prefetch" href="/assets/js/154.fa61ee21.js"><link rel="prefetch" href="/assets/js/155.42087f9f.js"><link rel="prefetch" href="/assets/js/156.7745074e.js"><link rel="prefetch" href="/assets/js/157.804702be.js"><link rel="prefetch" href="/assets/js/158.b6fe8f70.js"><link rel="prefetch" href="/assets/js/159.8a7a433b.js"><link rel="prefetch" href="/assets/js/16.434879fd.js"><link rel="prefetch" href="/assets/js/160.1a976dd2.js"><link rel="prefetch" href="/assets/js/161.14311375.js"><link rel="prefetch" href="/assets/js/162.6bbdd1e5.js"><link rel="prefetch" href="/assets/js/163.2c60a568.js"><link rel="prefetch" href="/assets/js/164.e7567976.js"><link rel="prefetch" href="/assets/js/165.7a2dc778.js"><link rel="prefetch" href="/assets/js/166.c9a838e8.js"><link rel="prefetch" href="/assets/js/17.14403580.js"><link rel="prefetch" href="/assets/js/18.08ac9cad.js"><link rel="prefetch" href="/assets/js/19.2c183b64.js"><link rel="prefetch" href="/assets/js/20.32bb3cb9.js"><link rel="prefetch" href="/assets/js/21.d966558e.js"><link rel="prefetch" href="/assets/js/22.c75c7c76.js"><link rel="prefetch" href="/assets/js/23.7fd7f7c3.js"><link rel="prefetch" href="/assets/js/24.36b6b4eb.js"><link rel="prefetch" href="/assets/js/25.8f357f46.js"><link rel="prefetch" href="/assets/js/26.61d906dd.js"><link rel="prefetch" href="/assets/js/27.08330a35.js"><link rel="prefetch" href="/assets/js/28.b1e01410.js"><link rel="prefetch" href="/assets/js/29.936218e3.js"><link rel="prefetch" href="/assets/js/3.3214ea23.js"><link rel="prefetch" href="/assets/js/30.c0b9efde.js"><link rel="prefetch" href="/assets/js/31.5b6e3df7.js"><link rel="prefetch" href="/assets/js/32.6374edaf.js"><link rel="prefetch" href="/assets/js/33.928e8282.js"><link rel="prefetch" href="/assets/js/34.92067108.js"><link rel="prefetch" href="/assets/js/35.154d21dd.js"><link rel="prefetch" href="/assets/js/36.e5ad0869.js"><link rel="prefetch" href="/assets/js/37.385b33d5.js"><link rel="prefetch" href="/assets/js/38.215a6333.js"><link rel="prefetch" href="/assets/js/4.d34ebd53.js"><link rel="prefetch" href="/assets/js/40.bc0f7c00.js"><link rel="prefetch" href="/assets/js/41.3ba84cff.js"><link rel="prefetch" href="/assets/js/42.04a42e98.js"><link rel="prefetch" href="/assets/js/43.9a5e58fa.js"><link rel="prefetch" href="/assets/js/44.ad33bbd6.js"><link rel="prefetch" href="/assets/js/45.17f6595d.js"><link rel="prefetch" href="/assets/js/46.a5afba11.js"><link rel="prefetch" href="/assets/js/47.838086e6.js"><link rel="prefetch" href="/assets/js/48.34f3613a.js"><link rel="prefetch" href="/assets/js/49.726aa7d7.js"><link rel="prefetch" href="/assets/js/5.95ea0968.js"><link rel="prefetch" href="/assets/js/50.cb833116.js"><link rel="prefetch" href="/assets/js/51.3ed1ad45.js"><link rel="prefetch" href="/assets/js/52.54cf0f85.js"><link rel="prefetch" href="/assets/js/53.513a15ca.js"><link rel="prefetch" href="/assets/js/54.48b671a4.js"><link rel="prefetch" href="/assets/js/55.4ea41ff7.js"><link rel="prefetch" href="/assets/js/56.2c85bb70.js"><link rel="prefetch" href="/assets/js/57.c4b7c57f.js"><link rel="prefetch" href="/assets/js/58.8645cbfa.js"><link rel="prefetch" href="/assets/js/59.93bb241a.js"><link rel="prefetch" href="/assets/js/6.d3d6f703.js"><link rel="prefetch" href="/assets/js/60.bb6e6605.js"><link rel="prefetch" href="/assets/js/61.286ce4e5.js"><link rel="prefetch" href="/assets/js/62.faedf14e.js"><link rel="prefetch" href="/assets/js/63.ce821da4.js"><link rel="prefetch" href="/assets/js/64.d3bd4444.js"><link rel="prefetch" href="/assets/js/65.6dce8124.js"><link rel="prefetch" href="/assets/js/66.9926dcf1.js"><link rel="prefetch" href="/assets/js/67.8ba47f6f.js"><link rel="prefetch" href="/assets/js/68.fb08fa45.js"><link rel="prefetch" href="/assets/js/69.99366761.js"><link rel="prefetch" href="/assets/js/7.65a53a16.js"><link rel="prefetch" href="/assets/js/70.b58184ca.js"><link rel="prefetch" href="/assets/js/71.e807ce86.js"><link rel="prefetch" href="/assets/js/72.fd85a201.js"><link rel="prefetch" href="/assets/js/73.347f4455.js"><link rel="prefetch" href="/assets/js/74.1614468f.js"><link rel="prefetch" href="/assets/js/75.1b48dd21.js"><link rel="prefetch" href="/assets/js/76.34386640.js"><link rel="prefetch" href="/assets/js/77.98723d2f.js"><link rel="prefetch" href="/assets/js/78.853e0232.js"><link rel="prefetch" href="/assets/js/79.f13b56d9.js"><link rel="prefetch" href="/assets/js/8.1f5a2468.js"><link rel="prefetch" href="/assets/js/80.9b7ea6e5.js"><link rel="prefetch" href="/assets/js/81.b6c297c9.js"><link rel="prefetch" href="/assets/js/82.0f97cc22.js"><link rel="prefetch" href="/assets/js/83.31634315.js"><link rel="prefetch" href="/assets/js/84.c8e9154d.js"><link rel="prefetch" href="/assets/js/85.961b5b48.js"><link rel="prefetch" href="/assets/js/86.0656beb0.js"><link rel="prefetch" href="/assets/js/87.2216b902.js"><link rel="prefetch" href="/assets/js/88.5f59eb52.js"><link rel="prefetch" href="/assets/js/89.c1a19999.js"><link rel="prefetch" href="/assets/js/9.4ab6239e.js"><link rel="prefetch" href="/assets/js/90.c3ffff3a.js"><link rel="prefetch" href="/assets/js/91.093bc4a1.js"><link rel="prefetch" href="/assets/js/92.b98a6c4b.js"><link rel="prefetch" href="/assets/js/93.721ce10b.js"><link rel="prefetch" href="/assets/js/94.2c601c95.js"><link rel="prefetch" href="/assets/js/95.d1677f3d.js"><link rel="prefetch" href="/assets/js/96.e71019bc.js"><link rel="prefetch" href="/assets/js/97.d7a92048.js"><link rel="prefetch" href="/assets/js/98.21bdf582.js"><link rel="prefetch" href="/assets/js/99.5df4fe80.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0ada997.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="mycat-高可用3种（zookeeper-haproxy-keepalived-）"><a href="#mycat-高可用3种（zookeeper-haproxy-keepalived-）" aria-hidden="true" class="header-anchor">#</a> mycat 高可用3种（zookeeper  haproxy  keepalived ）</h2> <h3 id="_1、mycat的高可用"><a href="#_1、mycat的高可用" aria-hidden="true" class="header-anchor">#</a> 1、mycat的高可用</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>​		listen proxy_status
        	bind :48066
        		mode tcp
        		balance roundrobin
        		server mycat_1 192.168.85.111:8066 check inter 10s
        		server mycat_2 192.168.85.112:8066 check inter 10s
</code></pre></div><p>​		
在mycat的权威指南中，介绍了多种高可用的方案，在这里我们讲解一种使用最多的方案，使用HAProxy+Keepalived配合使用来实现myact的高可用。</p> <p>​		HAproxy实现了mycat多借点的集群高可用和负载均衡，而HAProxy自身的高可用则可以通过Keepalived来实现。</p> <p><img src="/img/mysql/mycat%E9%AB%98%E5%8F%AF%E7%94%A8.png" alt="image-20200626204106407"></p> <p>​		好了，如果这个图大家看明白的话，下面我们开始规划集群并进行实操。</p> <table><thead><tr><th>编号</th> <th>角色</th> <th>IP地址</th> <th>机器名</th></tr></thead> <tbody><tr><td>1</td> <td>mycat1</td> <td>192.168.85.111</td> <td>node01</td></tr> <tr><td>2</td> <td>mycat2</td> <td>192.168.85.112</td> <td>node02</td></tr> <tr><td>3</td> <td>HAProxy(master)</td> <td>192.168.85.113</td> <td>node03</td></tr> <tr><td>4</td> <td>Keepalived(master)</td> <td>192.168.85.113</td> <td>node03</td></tr> <tr><td>5</td> <td>HAProxy(backup)</td> <td>192.168.85.114</td> <td>node04</td></tr> <tr><td>6</td> <td>keepalived(backup)</td> <td>192.168.85.114</td> <td>node04</td></tr></tbody></table> <h4 id="_1、安装配置haproxy"><a href="#_1、安装配置haproxy" aria-hidden="true" class="header-anchor">#</a> 1、安装配置HAProxy</h4> <p>listen proxy_status
bind :48066
mode tcp
balance roundrobin
server mycat_1 192.168.85.111:8066 check inter 10s
server mycat_2 192.168.85.112:8066 check inter 10s</p> <div class="language- extra-class"><pre class="language-text"><code>1、准备好HAProxy的安装包
2、解压到/usr/local目录
3、进入到解压后的目录，查看内核版本，进行编译
	cd cd /usr/local/haproxy-1.8.25/
	uname -r
	make TARGET=linux26
4、编译完成之后，开始进行安装
	make install PREFIX=/usr/local/haproxy
5、安装完成之后，创建目录，创建HAProxy配置文件
	mkdir -p /usr/data/haproxy
	mkdir /usr/local/haproxy/conf
	vi /usr/local/haproxy/haproxy.conf
6、向配置文件中添加配置信息
	global
		log 127.0.0.1 local0
		#log 127.0.0.1 local1 notice
		#log loghost local0 info
		maxconn 4096
		chroot /usr/local/haproxy
		pidfile /usr/data/haproxy/haproxy.pid
		uid 99
		gid 99
		daemon
		#debug
		#quiet
defaults
		log global
		mode tcp
		option abortonclose
		option redispatch
		retries 3
		maxconn 2000
		timeout connect 5000
		timeout client 50000
		timeout server 50000
listen proxy_status
	bind :48066
		mode tcp
		balance roundrobin
		server mycat_1 192.168.85.111:8066 check inter 10s
		server mycat_2 192.168.85.112:8066 check inter 10s
frontend admin_stats
	bind :7777
		mode http
		stats enable
		option httplog
		maxconn 10
		stats refresh 30s
		stats uri /admin
		stats auth admin:123123
		stats hide-version
		stats admin if TRUE
7、启动haproxy服务
	/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/conf/haproxy.conf
8、查看haproxy的进程，如果存在则说明没有问题
	ps -ef | grep haproxy
9、打开浏览器访问,用户名为admin，密码为123123
	http://192.168.85.113:7777/admin
</code></pre></div><h4 id="_2、另一台上按照上述一样的步骤创建haproxy"><a href="#_2、另一台上按照上述一样的步骤创建haproxy" aria-hidden="true" class="header-anchor">#</a> 2、另一台上按照上述一样的步骤创建HAProxy</h4> <h4 id="_3、安装配置keepalived"><a href="#_3、安装配置keepalived" aria-hidden="true" class="header-anchor">#</a> 3、安装配置Keepalived</h4> <p>virtual_ipaddress {
192.168.85.200/24 dev eth0 label eth0:3:
}</p> <div class="language- extra-class"><pre class="language-text"><code>1、准备好Keepalived安装包
2、解压到/usr/local目录
3、安装需要依赖的环境组件
	yum install gcc openssl-devel popt-devel -y
4、进入到解压目录，进行编译
	./configure --prefix=/usr/local/keepalived
5、编译完成之后，进行安装
	make &amp;&amp; make install
6、将keepalived的服务注册为系统服务
	cp /usr/local/keepalived-1.4.5/keepalived/etc/init.d/keepalived /etc/init.d/
	mkdir /etc/keepalived
	cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/
	cp /usr/local/keepalived-1.4.5/keepalived/etc/sysconfig/keepalived /etc/sysconfig/
	cp /usr/local/keepalived/sbin/keepalived /usr/sbin/
7、修改配置文件
	cd etc/keepalived/
	vi keepalived.conf
	
	! Configuration File for keepalived

global_defs {
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
   vrrp_skip_check_adv_addr
   vrrp_garp_interval 0
   vrrp_gna_interval 0
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.85.200/24 dev eth0 label eth0:3:
    }
}

8、启动keepalived
	service keepalived start
9、登录验证
	mysql -uroot -p123456 -h 192.168.85.100 -P 48066
</code></pre></div><h4 id="在node04上执行相同的操作安装keepalived-注意，需要修改状态为backup-另一台是master"><a href="#在node04上执行相同的操作安装keepalived-注意，需要修改状态为backup-另一台是master" aria-hidden="true" class="header-anchor">#</a> 在node04上执行相同的操作安装keepalived 注意，需要修改状态为BACKUP 另一台是master</h4> <h2 id="为什么用mycat"><a href="#为什么用mycat" aria-hidden="true" class="header-anchor">#</a> 为什么用mycat</h2> <p>1.java与数据库紧耦合，解藕
2.高访问量高并发对数据库对压力，负载均衡
3.读写请求数据不一致，读写分离，主从复制</p> <h2 id="mycat"><a href="#mycat" aria-hidden="true" class="header-anchor">#</a> mycat</h2> <p>原理：
拦截用户sql进行:
1.分片分析
2.路由分析
3.读写分离分析
4.缓存分析
<img src="/img/mysql/mycat_1.png" alt="mycat">
上述图片里，orders表被分为了三个分片datanode（简称dn），</p> <p>这三个分片是分布在两台MySQL Server上（Datahost），即datanode=database@datahost方式，</p> <p>因此你可以用一台到N台服务器来分片，分片规则为（sharding rule）典型的字符串枚举分片规则，</p> <p>一个规则的定义是分片字段（sharding column）+分片函数（rule function）,</p> <p>这里的分片字段为prov而分片函数为字符串枚举方式。</p> <p>当mycat收到一个SQL时，会先解析这个SQL,查找涉及到的表，然后看此表的定义，如果有分片规则，</p> <p>则获取到SQL里分片字段的值，并分配分片函数，得到该SQL对应的分片列表，然后将SQL发往这些分片去执行，</p> <p>最后收集和处理所有分片返回的结果数据，并输出到客户端，以select * from orders where prov = ?语句为例，</p> <p>查到prov=wuhan,按照分片函数，wuhan返回dn1,于是sql就发给了mysql1，去取db1上的查询结果，并返回给用户。</p> <p>如果上述sql改为select * from orders where prov in (wuhan,beijing),那么，</p> <p>sql就会发给MySQL1和MySQL2去执行，然后结果集合并后输出给用户。</p> <p>但通常业务中我们的SQL会有order by以及limit翻页语法，此时就设计到结果集在mycat端的二次处理，</p> <p>这部分代码也比较复杂，而最复杂的则属两个表的join，为此，mycat提出了创新性的ER分片，全局表，</p> <p>HBT（human brain tech）人工智能的catlet，以及结合storm/spark引擎等十八般武艺的解决办法，</p> <p>从而称为目前业界最强大的方案，这就是开源的力量。</p> <h3 id="server-xml-用户-权限-系统属性"><a href="#server-xml-用户-权限-系统属性" aria-hidden="true" class="header-anchor">#</a> server.xml 用户 权限 系统属性</h3> <h3 id="schema-xml-逻辑库逻辑表-以及对应对数据节点和服务器"><a href="#schema-xml-逻辑库逻辑表-以及对应对数据节点和服务器" aria-hidden="true" class="header-anchor">#</a> schema.xml 逻辑库逻辑表 以及对应对数据节点和服务器</h3> <h5 id="datahost标签"><a href="#datahost标签" aria-hidden="true" class="header-anchor">#</a> dataHost标签</h5> <p>​		该标签定义了具体的数据库实例、读写分离配置和心跳语句</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>localhost1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1000<span class="token punctuation">&quot;</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mysql<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>native<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">&gt;</span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- can have multi write hosts --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>hostM1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>localhost:3306<span class="token punctuation">&quot;</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>123456<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- can have multi read hosts --&gt;</span>
<span class="token comment">&lt;!-- &lt;readHost host=&quot;hostS1&quot; url=&quot;localhost:3306&quot; user=&quot;root&quot; password=&quot;123456&quot;
/&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>writeHost</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- &lt;writeHost host=&quot;hostM2&quot; url=&quot;localhost:3316&quot; user=&quot;root&quot; password=&quot;123456&quot;/&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>​		**name：**唯一标识dataHost标签，供上层的标签使用</p> <p>​		**maxcon：**指定每个读写实例连接池的最大连接</p> <p>​		**mincon：**指定每个读写实例连接连接池的最小链接，初始化连接池的大小</p> <p>​		**balance：**负载均衡类型：</p> <p>​		0：不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</p> <p>​		1：全部的readHost和stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式（M1-&gt;S1,M2-&gt;S2,并且M1与M2互为主备），正常情况下，M2,S1,S2都参与select语句的负载均衡</p> <p>​		2：所有读操作都随机的再writeHost、readHost上分发</p> <p>​		3：所有读请求随机的分发到writeHost对应readHost执行，writeHost不负担读压力，在之后的版本中失效。</p> <p>​		**writeType：**写类型</p> <p>​		writeType=0：所有的写操作发送到配置的第一个writeHost，第一个挂了切换到还生存的第二个writeHost，重启之后以切换后的为准，切换记录保存在配置文件 dnindex.properties</p> <p>​		writeType=1：所有写操作都随机的发送到配置的writeHost，1.5以后废弃不推荐</p> <p>​		**dbType：**指定后端连接的数据库类型，如MySQL，mongodb,oracle</p> <p>​		**dbDriver：**指定连接后端数据库使用的Driver，目前可选的值有native和JDBC。使用native的话，因为这个值执行的是二进制的mysql协议，所以可以使用mysql和maridb，其他类型的数据库则需要使用JDBC驱动来支持。</p> <p>​		**switchType：**是否进行主从切换</p> <p>​		-1：表示不自动切换</p> <p>​		1：默认值，自动切换</p> <p>​		2：基于mysql主从同步的状态决定是否切换</p> <h5 id="_6、heartbeat标签"><a href="#_6、heartbeat标签" aria-hidden="true" class="header-anchor">#</a> 6、heartbeat标签</h5> <p>​		这个标签指明用于和后端数据库进行心跳检测的语句。</p> <h3 id="rule-xml"><a href="#rule-xml" aria-hidden="true" class="header-anchor">#</a> rule.xml</h3> <h2 id="垂直分-按照业务分历史订单查询-多用户-schema"><a href="#垂直分-按照业务分历史订单查询-多用户-schema" aria-hidden="true" class="header-anchor">#</a> 垂直分   按照业务分历史订单查询 多用户 schema</h2> <p>一个数据库由很多表构成，每个表对应不同的业务，垂直切分是指按照业务将表进行分类并分不到不同的节点上，垂直拆分简单明了，拆分规则明确，应用程序模块清晰、明确、容易整合，但是某个表的数据量达到一定程度后扩展起来比较困难
100个表根据业务分到3个数据库</p> <h3 id="垂直分表配置"><a href="#垂直分表配置" aria-hidden="true" class="header-anchor">#</a> 垂直分表配置</h3> <p>schema.xml</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;dn1&quot;&gt;
		&lt;table name = &quot;customer&quot; dataNode=&quot;dn2&quot;&gt;&lt;/table&gt;
&lt;/schema&gt;
</code></pre></div><p>这样 customer就在dn2里</p> <h2 id="水平分-主要-按照数据分-join-要用他"><a href="#水平分-主要-按照数据分-join-要用他" aria-hidden="true" class="header-anchor">#</a> 水平分 ****主要 按照数据分 join 要用他</h2> <p>按照某个字段的某种规则分散到多个节点库中，每个节点中包含一部分数据。可以将数据的水平切分简单理解为按照数据行进行切分，就是将表中的某些行却分到一个节点，将另外某些行切分到其他节点，从分布式的整体来看它们是一个整体的表
1亿数据分到10个表</p> <h3 id="水平分库配置"><a href="#水平分库配置" aria-hidden="true" class="header-anchor">#</a> 水平分库配置</h3> <p>1、修改schema.xml文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TESTDB<span class="token punctuation">&quot;</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>100<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dn1<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>	
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>customer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dn2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span> <span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>orders<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dn1,dn2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mod_rule<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>	
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2、修改rule.xml文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mod_rule<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>customer_id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>mod-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mod-long<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByMod<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>		<span class="token comment">&lt;!-- how many data nodes --&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>count<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="分片规则-官网mycat权威指南"><a href="#分片规则-官网mycat权威指南" aria-hidden="true" class="header-anchor">#</a> 分片规则 官网mycat权威指南</h3> <h4 id="_0"><a href="#_0" aria-hidden="true" class="header-anchor">#</a> 0</h4> <p>单库分表
<br> <table name="city" primaryKey="id" autoIncrement="true" subTables="city_$1-3" dataNode="dn1" rule="mod-long"></table></p> <h4 id="_1-取模运算-根据节点数量取模分"><a href="#_1-取模运算-根据节点数量取模分" aria-hidden="true" class="header-anchor">#</a> 1 取模运算 根据节点数量取模分</h4> <h4 id="_2-分片枚举-识别的枚举值匹配节点，不匹配就让它路由到默认节点（需要配置，不然报错）"><a href="#_2-分片枚举-识别的枚举值匹配节点，不匹配就让它路由到默认节点（需要配置，不然报错）" aria-hidden="true" class="header-anchor">#</a> 2 分片枚举 识别的枚举值匹配节点，不匹配就让它路由到默认节点（需要配置，不然报错）</h4> <h4 id="_3-范围分片-那个范围走哪个节点"><a href="#_3-范围分片-那个范围走哪个节点" aria-hidden="true" class="header-anchor">#</a> 3 范围分片 那个范围走哪个节点</h4> <h4 id="_4-范围求模算法-哪个范围占有多少节点-超出是默认"><a href="#_4-范围求模算法-哪个范围占有多少节点-超出是默认" aria-hidden="true" class="header-anchor">#</a> 4 范围求模算法  哪个范围占有多少节点 超出是默认</h4> <h4 id="_5-固定分片hash算法-例如下面的-取模之后分三个区-0-255-256-511-512-1023"><a href="#_5-固定分片hash算法-例如下面的-取模之后分三个区-0-255-256-511-512-1023" aria-hidden="true" class="header-anchor">#</a> 5 固定分片hash算法  例如下面的 取模之后分三个区 0-255 256-511 512-1023</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>func1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByLong<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>partitionCount<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2,1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>partitionLength<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>256,512<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_6-取模范围算法-取模分区-如下是分三个"><a href="#_6-取模范围算法-取模分区-如下是分三个" aria-hidden="true" class="header-anchor">#</a> 6 取模范围算法 取模分区 如下是分三个</h4> <div class="language-xml extra-class"><pre class="language-xml"><code>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sharding-by-pattern<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByPattern<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mapFile<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>partition-pattern.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>patternVAlue<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>256<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>defaultNode<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
txt
0-86=0
87-173=1
174-256=2
</code></pre></div><h4 id="_7-字符串hash求模范围算法-columns标识将要分片的表字段"><a href="#_7-字符串hash求模范围算法-columns标识将要分片的表字段" aria-hidden="true" class="header-anchor">#</a> 7 字符串hash求模范围算法  columns标识将要分片的表字段</h4> <pre><code>                  algorithm为分片函数
                  mapFile：切分规则配置文件
                  patternValue：求模基数
                  prefixLength:ASCII 截取的位数
</code></pre> <h4 id="_8-应用指定的算法-某些前缀（截取）的数字匹配到哪个分片"><a href="#_8-应用指定的算法-某些前缀（截取）的数字匹配到哪个分片" aria-hidden="true" class="header-anchor">#</a> 8 应用指定的算法   某些前缀（截取）的数字匹配到哪个分片</h4> <h4 id="_9-字符串hash解析算法-截取之后hash取模分区"><a href="#_9-字符串hash解析算法-截取之后hash取模分区" aria-hidden="true" class="header-anchor">#</a> 9 字符串hash解析算法  截取之后hash取模分区</h4> <h4 id="_10-按照日期范围分片-按照指定日期分片"><a href="#_10-按照日期范围分片-按照指定日期分片" aria-hidden="true" class="header-anchor">#</a> 10 按照日期范围分片 ***** 按照指定日期分片</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--
columns：分片字段， algorithm：分片函数
dateFormat ：日期格式
sBeginDate ：开始日期
sEndDate：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入
sPartionDay ：分区天数，即默认从开始日期算起，分隔 2 天一个分区
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>shardingByDate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dateFormat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>yyyy-MM-dd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sBeginDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2020-06-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sEndDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2020-06-04<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sPartionDay<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h4 id="_11-按单月小时分片-此规则是单月内按照小时拆分，最小粒度是小时，可以一天最多24个分片，最少一个分片，一个月完成后下个月开始循环，每个月月尾，需要手工清理数据。"><a href="#_11-按单月小时分片-此规则是单月内按照小时拆分，最小粒度是小时，可以一天最多24个分片，最少一个分片，一个月完成后下个月开始循环，每个月月尾，需要手工清理数据。" aria-hidden="true" class="header-anchor">#</a> 11 按单月小时分片 此规则是单月内按照小时拆分，最小粒度是小时，可以一天最多24个分片，最少一个分片，一个月完成后下个月开始循环，每个月月尾，需要手工清理数据。</h4> <h4 id="_12-日期范围hash分片"><a href="#_12-日期范围hash分片" aria-hidden="true" class="header-anchor">#</a> 12 日期范围hash分片</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--
columns： 拆分字段，字符串类型（yyyymmddHH）
algorithm:分片函数
sBeginDate:指定开始的日期，与dateFormat格式一致
sPartionDay:代表多少天一组
dateFormat:指定的日期格式，符合java标准
groupPartionSize  每几个分片是单独的几个组 （sPartionDay*dn数/groupPartionSize=分片数）
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>range-date-hash<span class="token punctuation">&quot;</span></span>
<span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByRangeDateHash<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sBeginDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2020-06-01 00:00:00<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sPartionDay<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dateFormat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>yyyy-MM-dd HH:mm:ss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>groupPartionSize<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_13-冷热数据分片-dn1-10天-dn2所有的-dn3空-其他库"><a href="#_13-冷热数据分片-dn1-10天-dn2所有的-dn3空-其他库" aria-hidden="true" class="header-anchor">#</a> 13 冷热数据分片 dn1 10天 dn2所有的 dn3空 其他库</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--
dataFormat：时间格式化
sLastDay:热数据的天数
sPartionDay:冷数据的分片天数（按照天数分片）
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sharding-by-hotdate<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByHotDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dateFormat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>yyyy-MM-dd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sLastDay<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sPartionDay<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_14-自然月分片-一个月一个片"><a href="#_14-自然月分片-一个月一个片" aria-hidden="true" class="header-anchor">#</a> 14 自然月分片 一个月一个片</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--
columns： 分片字段，字符串类型
dateFormat ： 日期字符串格式
sBeginDate ： 开始日期
--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sharding-by-month<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByMonth<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dateFormat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>yyyy-MM-dd<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sBeginDate<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2019-01-01<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_15-一致性hash分片"><a href="#_15-一致性hash分片" aria-hidden="true" class="header-anchor">#</a> 15 一致性hash分片</h4> <p>修改schema.xml文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>user10<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>dn1,dn2,dn3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">primaryKey</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>id<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sharding-by-murmur<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>修改rule.xml文件</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sharding-by-murmur<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>murmur<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>murmur<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>io.mycat.route.function.PartitionByMurmurHash<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>seed<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 默认是 0--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>count<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>virtualBucketTimes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>160<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是 160 倍，也就是虚拟节点数是物理节点数的 160 倍--&gt;</span>
<span class="token comment">&lt;!--&lt;property name=&quot;weightMapFile&quot;&gt;weightMapFile&lt;/property&gt;
节点的权重，没有指定权重的节点默认是 1。以 properties 文件的格式填写，以从 0 开始到 count-1 的整数值也就是节点索引为 key，以节点权重值为值。所有权重值必须是正整数，否则以 1 代替 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>bucketMapPath<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>/etc/mycat/bucketMapPath<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的 murmur hash 值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="mycat原理"><a href="#mycat原理" aria-hidden="true" class="header-anchor">#</a> mycat原理</h3> <p>​		学到这里同学们其实应该有感受了，mycat的操作使用并不是很难，我们只需要配置和修改server.xml.rule.xml.schema.xml三个文件即可，但是如果想在生产环境中使用的话，还是需要下一番功夫的，在准备这套课程的时候我也想过找一些生产环境中的案例给大家做一个演示，但是发现没有特别合适的案例，这块的实操我们会放到P8课程中给大家进行讲解，下面我们来简单说一下mycat的原理。</p> <p>​		mycat在逻辑上由几个模块组成：通信协议、路由解析、结果集处理、数据库连接、监控等模块</p> <p><img src="/img/mysql/mycat%E5%90%84%E6%A8%A1%E5%9D%97%E4%BA%A4%E4%BA%92.png" alt="image-20200703190120509"></p> <p>​		1、通信协议模块</p> <p>​		通信协议模块承担底层的收发数据、现成回调处理工作，主要采用Reactor、Proactor模式来提高效率。目前。mycat通信模块默认采用Reactor模式，在协议层采用mysql协议。</p> <p>​		2、路由解析模块</p> <p>​		路由解析模块负责对传入的SQL语句进行语法解析，解析从MYSQL协议中解析出来并进入该模块的SQL语句的条件、语句类型、携带的关键字等，对符合要求的SQL语句进行相关优化，最后根据这些路由计算单元进行路由计算。</p> <p>​		3、结果集处理模块</p> <p>​		结果集处理模块负责对跨分片的结果进行汇聚、排序、截取等。由于数据存储在不同的数据库中，所以对跨分片的数据需要进行汇聚。</p> <p>​		4、数据库连接模块</p> <p>​		数据库连接模块复制创建、管理、维护后端的连接池。为了减少每次建立数据库连接的开销，数据库使用连接池机制对连接生命周期进行管理。</p> <p>​		5、监控管理模块</p> <p>​		监控管理模块负责对Mycat中的连接、内存等资源进行等监控和管理。监控主要是通过管理命令实时地展现一些监控数据，例如连接数、缓存命中数等；管理则主要通过轮训事件来检测和释放不适用的资源。</p> <p>​		6、SQL执行模块</p> <p>​		SQL执行模块负责从连接池中获取相应的目标连接，对目标连接进行信息同步后，再根据路由解析的结果，把SQL语句分发到相应的节点执行。</p> <p>​		总体执行流程如下：</p> <p>​		由通信协议模块的读写事件通知发起。读写事件通知具体的回调代码进行这次读写事件的处理。管理模块的执行流程由定时器事件进行资源检查和资源释放时发起。</p> <p>​		由客户端发送过来的数据通过协议解析、路由解析等流程进入执行组件，通过执行组件把数据发送到通信协议模块，最终数据被写入目标数据库。</p> <p>​		后端数据库返回数据，通过协议解析后发送至回调模块。如果是涉及多节点的数据，则执行流程将会先进入结果集汇聚、排序等模块中，然后将处理后的数据通过通信协议模块返回到客户端。</p> <p><img src="/img/mysql/mycat%E6%B5%81%E7%A8%8B.png" alt="image-20200705150407895"></p> <h4 id="修改server-xml"><a href="#修改server-xml" aria-hidden="true" class="header-anchor">#</a> 修改server.xml</h4> <h5 id="用户权限"><a href="#用户权限" aria-hidden="true" class="header-anchor">#</a> 用户权限</h5> <div class="language-xml extra-class"><pre class="language-xml"><code>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span> <span class="token attr-name">defaultAccount</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>schemas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>TESTDB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mycat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>mycat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>schemas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>TESTDB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>readOnly<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="权限"><a href="#权限" aria-hidden="true" class="header-anchor">#</a> 权限</h5> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mycat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>mycat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>schemas<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>TESTDB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>privileges</span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>TESTDB<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dml</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>1111<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>orders<span class="token punctuation">&quot;</span></span> <span class="token attr-name">dml</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>0000<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>privileges</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="还有sql拦截-和黑白名单"><a href="#还有sql拦截-和黑白名单" aria-hidden="true" class="header-anchor">#</a> 还有sql拦截 和黑白名单</h5> <div class="language-xml extra-class"><pre class="language-xml"><code>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>firewall</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>whitehost</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>192.168.85.111<span class="token punctuation">&quot;</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>mycat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>whitehost</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>firewall</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>blacklist</span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>deleteAllow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>blacklist</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a8d644b6.js" defer></script><script src="/assets/js/2.b0571e25.js" defer></script><script src="/assets/js/39.bbf6207d.js" defer></script>
  </body>
</html>
