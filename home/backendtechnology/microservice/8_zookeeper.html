<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Zookeeper</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.a0ada997.css" as="style"><link rel="preload" href="/assets/js/app.a8d644b6.js" as="script"><link rel="preload" href="/assets/js/2.b0571e25.js" as="script"><link rel="preload" href="/assets/js/113.b8841596.js" as="script"><link rel="prefetch" href="/assets/js/10.c8889642.js"><link rel="prefetch" href="/assets/js/100.51a741fb.js"><link rel="prefetch" href="/assets/js/101.d9dbfe05.js"><link rel="prefetch" href="/assets/js/102.52466a3b.js"><link rel="prefetch" href="/assets/js/103.3cf394c6.js"><link rel="prefetch" href="/assets/js/104.90d3018b.js"><link rel="prefetch" href="/assets/js/105.dd9bdeef.js"><link rel="prefetch" href="/assets/js/106.6bda79d0.js"><link rel="prefetch" href="/assets/js/107.ef743f0b.js"><link rel="prefetch" href="/assets/js/108.fa92013e.js"><link rel="prefetch" href="/assets/js/109.50afa695.js"><link rel="prefetch" href="/assets/js/11.e31c3ea5.js"><link rel="prefetch" href="/assets/js/110.aad632dd.js"><link rel="prefetch" href="/assets/js/111.499096ad.js"><link rel="prefetch" href="/assets/js/112.6069b48f.js"><link rel="prefetch" href="/assets/js/114.23496351.js"><link rel="prefetch" href="/assets/js/115.e08ac3c1.js"><link rel="prefetch" href="/assets/js/116.760ebdb3.js"><link rel="prefetch" href="/assets/js/117.f226c0c1.js"><link rel="prefetch" href="/assets/js/118.65289b19.js"><link rel="prefetch" href="/assets/js/119.e3cf777f.js"><link rel="prefetch" href="/assets/js/12.78a1ab5b.js"><link rel="prefetch" href="/assets/js/120.7760e751.js"><link rel="prefetch" href="/assets/js/121.05ec49dd.js"><link rel="prefetch" href="/assets/js/122.688774b7.js"><link rel="prefetch" href="/assets/js/123.06bf7f11.js"><link rel="prefetch" href="/assets/js/124.62bfda58.js"><link rel="prefetch" href="/assets/js/125.eda5b500.js"><link rel="prefetch" href="/assets/js/126.1b39c0b0.js"><link rel="prefetch" href="/assets/js/127.65be59e4.js"><link rel="prefetch" href="/assets/js/128.25fbb5dc.js"><link rel="prefetch" href="/assets/js/129.cd5e2b4b.js"><link rel="prefetch" href="/assets/js/13.6a543448.js"><link rel="prefetch" href="/assets/js/130.fcc93329.js"><link rel="prefetch" href="/assets/js/131.6d7c37d1.js"><link rel="prefetch" href="/assets/js/132.09cf25fb.js"><link rel="prefetch" href="/assets/js/133.583d15f0.js"><link rel="prefetch" href="/assets/js/134.7b72ef87.js"><link rel="prefetch" href="/assets/js/135.733d2857.js"><link rel="prefetch" href="/assets/js/136.b8649b26.js"><link rel="prefetch" href="/assets/js/137.e71138fa.js"><link rel="prefetch" href="/assets/js/138.95b4f55f.js"><link rel="prefetch" href="/assets/js/139.c09e22b6.js"><link rel="prefetch" href="/assets/js/14.819689ab.js"><link rel="prefetch" href="/assets/js/140.71186b46.js"><link rel="prefetch" href="/assets/js/141.5bb51b5a.js"><link rel="prefetch" href="/assets/js/142.94804f8e.js"><link rel="prefetch" href="/assets/js/143.7191f64e.js"><link rel="prefetch" href="/assets/js/144.d2957568.js"><link rel="prefetch" href="/assets/js/145.651e0adf.js"><link rel="prefetch" href="/assets/js/146.d0a83694.js"><link rel="prefetch" href="/assets/js/147.fc4d286f.js"><link rel="prefetch" href="/assets/js/148.410aec93.js"><link rel="prefetch" href="/assets/js/149.a453f4de.js"><link rel="prefetch" href="/assets/js/15.5bc49d67.js"><link rel="prefetch" href="/assets/js/150.77f0ea12.js"><link rel="prefetch" href="/assets/js/151.c808f32e.js"><link rel="prefetch" href="/assets/js/152.22e5d574.js"><link rel="prefetch" href="/assets/js/153.bc4da283.js"><link rel="prefetch" href="/assets/js/154.fa61ee21.js"><link rel="prefetch" href="/assets/js/155.42087f9f.js"><link rel="prefetch" href="/assets/js/156.7745074e.js"><link rel="prefetch" href="/assets/js/157.804702be.js"><link rel="prefetch" href="/assets/js/158.b6fe8f70.js"><link rel="prefetch" href="/assets/js/159.8a7a433b.js"><link rel="prefetch" href="/assets/js/16.434879fd.js"><link rel="prefetch" href="/assets/js/160.1a976dd2.js"><link rel="prefetch" href="/assets/js/161.14311375.js"><link rel="prefetch" href="/assets/js/162.6bbdd1e5.js"><link rel="prefetch" href="/assets/js/163.2c60a568.js"><link rel="prefetch" href="/assets/js/164.e7567976.js"><link rel="prefetch" href="/assets/js/165.7a2dc778.js"><link rel="prefetch" href="/assets/js/166.c9a838e8.js"><link rel="prefetch" href="/assets/js/17.14403580.js"><link rel="prefetch" href="/assets/js/18.08ac9cad.js"><link rel="prefetch" href="/assets/js/19.2c183b64.js"><link rel="prefetch" href="/assets/js/20.32bb3cb9.js"><link rel="prefetch" href="/assets/js/21.d966558e.js"><link rel="prefetch" href="/assets/js/22.c75c7c76.js"><link rel="prefetch" href="/assets/js/23.7fd7f7c3.js"><link rel="prefetch" href="/assets/js/24.36b6b4eb.js"><link rel="prefetch" href="/assets/js/25.8f357f46.js"><link rel="prefetch" href="/assets/js/26.61d906dd.js"><link rel="prefetch" href="/assets/js/27.08330a35.js"><link rel="prefetch" href="/assets/js/28.b1e01410.js"><link rel="prefetch" href="/assets/js/29.936218e3.js"><link rel="prefetch" href="/assets/js/3.3214ea23.js"><link rel="prefetch" href="/assets/js/30.c0b9efde.js"><link rel="prefetch" href="/assets/js/31.5b6e3df7.js"><link rel="prefetch" href="/assets/js/32.6374edaf.js"><link rel="prefetch" href="/assets/js/33.928e8282.js"><link rel="prefetch" href="/assets/js/34.92067108.js"><link rel="prefetch" href="/assets/js/35.154d21dd.js"><link rel="prefetch" href="/assets/js/36.e5ad0869.js"><link rel="prefetch" href="/assets/js/37.385b33d5.js"><link rel="prefetch" href="/assets/js/38.215a6333.js"><link rel="prefetch" href="/assets/js/39.bbf6207d.js"><link rel="prefetch" href="/assets/js/4.d34ebd53.js"><link rel="prefetch" href="/assets/js/40.bc0f7c00.js"><link rel="prefetch" href="/assets/js/41.3ba84cff.js"><link rel="prefetch" href="/assets/js/42.04a42e98.js"><link rel="prefetch" href="/assets/js/43.9a5e58fa.js"><link rel="prefetch" href="/assets/js/44.ad33bbd6.js"><link rel="prefetch" href="/assets/js/45.17f6595d.js"><link rel="prefetch" href="/assets/js/46.a5afba11.js"><link rel="prefetch" href="/assets/js/47.838086e6.js"><link rel="prefetch" href="/assets/js/48.34f3613a.js"><link rel="prefetch" href="/assets/js/49.726aa7d7.js"><link rel="prefetch" href="/assets/js/5.95ea0968.js"><link rel="prefetch" href="/assets/js/50.cb833116.js"><link rel="prefetch" href="/assets/js/51.3ed1ad45.js"><link rel="prefetch" href="/assets/js/52.54cf0f85.js"><link rel="prefetch" href="/assets/js/53.513a15ca.js"><link rel="prefetch" href="/assets/js/54.48b671a4.js"><link rel="prefetch" href="/assets/js/55.4ea41ff7.js"><link rel="prefetch" href="/assets/js/56.2c85bb70.js"><link rel="prefetch" href="/assets/js/57.c4b7c57f.js"><link rel="prefetch" href="/assets/js/58.8645cbfa.js"><link rel="prefetch" href="/assets/js/59.93bb241a.js"><link rel="prefetch" href="/assets/js/6.d3d6f703.js"><link rel="prefetch" href="/assets/js/60.bb6e6605.js"><link rel="prefetch" href="/assets/js/61.286ce4e5.js"><link rel="prefetch" href="/assets/js/62.faedf14e.js"><link rel="prefetch" href="/assets/js/63.ce821da4.js"><link rel="prefetch" href="/assets/js/64.d3bd4444.js"><link rel="prefetch" href="/assets/js/65.6dce8124.js"><link rel="prefetch" href="/assets/js/66.9926dcf1.js"><link rel="prefetch" href="/assets/js/67.8ba47f6f.js"><link rel="prefetch" href="/assets/js/68.fb08fa45.js"><link rel="prefetch" href="/assets/js/69.99366761.js"><link rel="prefetch" href="/assets/js/7.65a53a16.js"><link rel="prefetch" href="/assets/js/70.b58184ca.js"><link rel="prefetch" href="/assets/js/71.e807ce86.js"><link rel="prefetch" href="/assets/js/72.fd85a201.js"><link rel="prefetch" href="/assets/js/73.347f4455.js"><link rel="prefetch" href="/assets/js/74.1614468f.js"><link rel="prefetch" href="/assets/js/75.1b48dd21.js"><link rel="prefetch" href="/assets/js/76.34386640.js"><link rel="prefetch" href="/assets/js/77.98723d2f.js"><link rel="prefetch" href="/assets/js/78.853e0232.js"><link rel="prefetch" href="/assets/js/79.f13b56d9.js"><link rel="prefetch" href="/assets/js/8.1f5a2468.js"><link rel="prefetch" href="/assets/js/80.9b7ea6e5.js"><link rel="prefetch" href="/assets/js/81.b6c297c9.js"><link rel="prefetch" href="/assets/js/82.0f97cc22.js"><link rel="prefetch" href="/assets/js/83.31634315.js"><link rel="prefetch" href="/assets/js/84.c8e9154d.js"><link rel="prefetch" href="/assets/js/85.961b5b48.js"><link rel="prefetch" href="/assets/js/86.0656beb0.js"><link rel="prefetch" href="/assets/js/87.2216b902.js"><link rel="prefetch" href="/assets/js/88.5f59eb52.js"><link rel="prefetch" href="/assets/js/89.c1a19999.js"><link rel="prefetch" href="/assets/js/9.4ab6239e.js"><link rel="prefetch" href="/assets/js/90.c3ffff3a.js"><link rel="prefetch" href="/assets/js/91.093bc4a1.js"><link rel="prefetch" href="/assets/js/92.b98a6c4b.js"><link rel="prefetch" href="/assets/js/93.721ce10b.js"><link rel="prefetch" href="/assets/js/94.2c601c95.js"><link rel="prefetch" href="/assets/js/95.d1677f3d.js"><link rel="prefetch" href="/assets/js/96.e71019bc.js"><link rel="prefetch" href="/assets/js/97.d7a92048.js"><link rel="prefetch" href="/assets/js/98.21bdf582.js"><link rel="prefetch" href="/assets/js/99.5df4fe80.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0ada997.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="zookeeper-的数据模型"><a href="#zookeeper-的数据模型" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的数据模型</h2> <p>Zookeeper 的数据模型是什么样子呢？它很像数据结构当中的树，也很像文件系统的目录。
<img src="/img/microservice/zk12.png" alt="zk1">
树是由节点所组成，Zookeeper 的数据存储也同样是基于节点，这种节点叫做 <strong>Znode</strong></p> <p>但是，不同于树的节点，Znode 的引用方式是路径引用，类似于文件路径：</p> <div class="language-sh extra-class"><pre class="language-sh"><code>/动物/猫
/汽车/宝马
</code></pre></div><p>这样的层级结构，让每一个 Znode 节点拥有唯一的路径，就像命名空间一样对不同信息作出清晰的隔离。</p> <h4 id="znode-包含哪些元素"><a href="#znode-包含哪些元素" aria-hidden="true" class="header-anchor">#</a> Znode 包含哪些元素</h4> <p><img src="/img/microservice/zk13.png" alt="zk1"></p> <ul><li>data：Znode 存储的数据信息。</li> <li>ACL：记录 Znode 的访问权限，即哪些人或哪些 IP 可以访问本节点。</li> <li>stat：包含 Znode 的各种元数据，比如事务 ID、版本号、时间戳、大小等等。</li> <li>child：当前节点的子节点引用
这里需要注意一点，Zookeeper 是为读多写少的场景所设计。Znode 并不是用来存储大规模业务数据，而是用于存储少量的状态和配置信息，<strong>每个节点的数据最大不能超过 1MB</strong>。</li></ul> <h2 id="zookeeper-的基本操作"><a href="#zookeeper-的基本操作" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的基本操作</h2> <p>创建节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>create
</code></pre></div><p>删除节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>delete
</code></pre></div><p>判断节点是否存在</p> <div class="language-sh extra-class"><pre class="language-sh"><code>exists
</code></pre></div><p>获得一个节点的数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code>getData
</code></pre></div><p>设置一个节点的数据</p> <div class="language-sh extra-class"><pre class="language-sh"><code>setData
</code></pre></div><p>获取节点下的所有子节点</p> <div class="language-sh extra-class"><pre class="language-sh"><code>getChildren
</code></pre></div><p>这其中，<code>exists</code>，<code>getData</code>，<code>getChildren</code> 属于读操作。Zookeeper 客户端在请求读操作的时候，可以选择是否设置 <strong>Watch</strong></p> <h2 id="zookeeper-的事件通知"><a href="#zookeeper-的事件通知" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的事件通知</h2> <p>我们可以把 <code>Watch</code> 理解成是注册在特定 Znode 上的触发器。当这个 Znode 发生改变，也就是调用了 <code>create</code> <code>delete</code> <code>setData</code>方法的时候，将会触发 <code>Znode</code> 上注册的对应事件，请求 Watch 的客户端会接收到异步通知。</p> <p>具体交互过程如下：</p> <ul><li>客户端调用 <code>getData</code> 方法，<code>watch</code> 参数是 true。服务端接到请求，返回节点数据，并且在对应的哈希表里插入被 Watch 的 Znode 路径，以及 Watcher 列表。
<img src="/img/microservice/zk14.png" alt="Samdoc"></li> <li>当被 Watch 的 Znode 已删除，服务端会查找哈希表，找到该 Znode 对应的所有 Watcher，异步通知客户端，并且删除哈希表中对应的 Key-Value。
<img src="/img/microservice/zk15.png" alt="Samdoc"></li></ul> <h2 id="zookeeper-的一致性"><a href="#zookeeper-的一致性" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的一致性</h2> <p>Zookeeper 身为分布式系统协调服务，如果自身挂了如何处理呢？为了防止单机挂掉的情况，Zookeeper 维护了一个集群。如下图：</p> <p><img src="/img/microservice/zk16.png" alt="Samdoc"></p> <p>Zookeeper Service 集群是一主多从结构。</p> <p>在更新数据时，首先更新到主节点（这里的节点是指服务器，不是 Znode），再同步到从节点。</p> <p>在读取数据时，直接读取任意从节点。</p> <p>为了保证主从节点的数据一致性，Zookeeper 采用了 ** ZAB 协议**，这种协议非常类似于一致性算法 <strong>Paxos</strong> 和 <strong>Raft</strong>。</p> <hr> <h4 id="什么是-zab"><a href="#什么是-zab" aria-hidden="true" class="header-anchor">#</a> 什么是 ZAB</h4> <p>Zookeeper Atomic Broadcast，有效解决了 Zookeeper 集群崩溃恢复，以及主从同步数据的问题。</p> <h4 id="zab-协议定义的三种节点状态"><a href="#zab-协议定义的三种节点状态" aria-hidden="true" class="header-anchor">#</a> ZAB 协议定义的三种节点状态</h4> <ul><li>Looking ：选举状态。</li> <li>Following ：Follower 节点（从节点）所处的状态。</li> <li>Leading ：Leader 节点（主节点）所处状态。</li></ul> <h4 id="最大-zxid"><a href="#最大-zxid" aria-hidden="true" class="header-anchor">#</a> 最大 ZXID</h4> <p>最大 ZXID 也就是节点本地的最新事务编号，包含 epoch 和计数两部分。epoch 是纪元的意思，相当于 Raft 算法选主时候的 term。</p> <h4 id="zab-的崩溃恢复"><a href="#zab-的崩溃恢复" aria-hidden="true" class="header-anchor">#</a> ZAB 的崩溃恢复</h4> <p>假如 Zookeeper 当前的主节点挂掉了，集群会进行崩溃恢复。ZAB 的崩溃恢复分成三个阶段：</p> <ul><li><strong>Leader election</strong></li></ul> <p>选举阶段，此时集群中的节点处于 Looking 状态。它们会各自向其他节点发起投票，投票当中包含自己的服务器 ID 和最新事务 ID（ZXID）。</p> <p><img src="/img/microservice/zk17.png" alt="Samdoc"></p> <p>接下来，节点会用自身的 ZXID 和从其他节点接收到的 ZXID 做比较，如果发现别人家的 ZXID 比自己大，也就是数据比自己新，那么就重新发起投票，投票给目前已知最大的 ZXID 所属节点。</p> <p><img src="/img/microservice/zk18.png" alt="Samdoc"></p> <p>每次投票后，服务器都会统计投票数量，判断是否有某个节点得到半数以上的投票。如果存在这样的节点，该节点将会成为准 Leader，状态变为 Leading。其他节点的状态变为 Following。</p> <p><img src="/img/microservice/zk19.png" alt="Samdoc"></p> <hr> <ul><li><strong>Discovery</strong></li></ul> <p>发现阶段，用于在从节点中发现最新的 ZXID 和事务日志。或许有人会问：既然 Leader 被选为主节点，已经是集群里数据最新的了，为什么还要从节点中寻找最新事务呢？</p> <p>这是为了防止某些意外情况，比如因网络原因在上一阶段产生多个 Leader 的情况。</p> <p>所以这一阶段，Leader 集思广益，接收所有 Follower 发来各自的最新 epoch 值。Leader 从中选出最大的 epoch，基于此值加 1，生成新的 epoch 分发给各个 Follower。</p> <p>各个 Follower 收到全新的 epoch 后，返回 ACK 给 Leader，带上各自最大的 ZXID 和历史事务日志。Leader 选出最大的 ZXID，并更新自身历史日志。</p> <ul><li><strong>Synchronization</strong></li></ul> <p>同步阶段，把 Leader 刚才收集得到的最新历史事务日志，同步给集群中所有的 Follower。只有当半数 Follower 同步成功，这个准 Leader 才能成为正式的 Leader。</p> <p>自此，故障恢复正式完成</p> <hr> <p><strong>ZAB 的数据写入</strong></p> <p><strong>Broadcast</strong></p> <p>ZAB 的数据写入涉及到 Broadcast 阶段，简单来说，就是 Zookeeper 常规情况下更新数据的时候，由 Leader 广播到所有的 Follower。其过程如下：</p> <ul><li>客户端发出写入数据请求给任意 Follower。</li> <li>Follower 把写入数据请求转发给 Leader。</li> <li>Leader 采用二阶段提交方式，先发送 Propose 广播给 Follower。</li> <li>Follower 接到 Propose 消息，写入日志成功后，返回 ACK 消息给 Leader。</li> <li>Leader 接到半数以上ACK消息，返回成功给客户端，并且广播 Commit 请求给 Follower</li></ul> <p><img src="/img/microservice/zk20.png" alt="Samdoc"></p> <p>ZAB 协议既不是强一致性，也不是弱一致性，而是处于两者之间的 <strong>单调一致性（顺序一致性）</strong>。它依靠事务 ID 和版本号，保证了数据的更新和读取是有序的。</p> <h2 id="zookeeper-的应用场景"><a href="#zookeeper-的应用场景" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的应用场景</h2> <h4 id="分布式锁"><a href="#分布式锁" aria-hidden="true" class="header-anchor">#</a> 分布式锁</h4> <p>这是雅虎研究员设计 Zookeeper 的初衷。利用 Zookeeper 的临时顺序节点，可以轻松实现分布式锁。</p> <h4 id="服务注册和发现"><a href="#服务注册和发现" aria-hidden="true" class="header-anchor">#</a> 服务注册和发现</h4> <p>利用 Znode 和 Watcher，可以实现分布式服务的注册和发现。最著名的应用就是阿里的分布式 RPC 框架 Dubbo。</p> <h4 id="共享配置和状态信息"><a href="#共享配置和状态信息" aria-hidden="true" class="header-anchor">#</a> 共享配置和状态信息</h4> <p>Redis 的分布式解决方案 Codis，就利用了 Zookeeper 来存放数据路由表和 codis-proxy 节点的元信息。同时 codis-config 发起的命令都会通过 ZooKeeper 同步到各个存活的 codis-proxy。</p> <p>此外，Kafka、HBase、Hadoop，也都依靠Zookeeper同步节点信息，实现高可用。</p> <h2 id="基于-docker-安装-zookeeper"><a href="#基于-docker-安装-zookeeper" aria-hidden="true" class="header-anchor">#</a> 基于 Docker 安装 Zookeeper</h2> <h3 id="概述"><a href="#概述" aria-hidden="true" class="header-anchor">#</a> 概述</h3> <p>Zookeeper 部署有三种方式，单机模式、集群模式、伪集群模式，以下采用 Docker 的方式部署</p> <p><strong>注意：</strong> 集群为大于等于3个奇数，如 3、5、7,不宜太多，集群机器多了选举和数据同步耗时长，不稳定。</p> <h3 id="单机模式"><a href="#单机模式" aria-hidden="true" class="header-anchor">#</a> 单机模式</h3> <h4 id="docker-compose-yml"><a href="#docker-compose-yml" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>version: <span class="token string">'3.1'</span>

services:
    zoo1:
        image: zookeeper
        restart: always
        hostname: zoo1
        ports:
            - <span class="token number">2181</span>:2181
        environment:
            ZOO_MY_ID: <span class="token number">1</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span>zoo1:2888:3888
</code></pre></div><h4 id="验证是否安装成功"><a href="#验证是否安装成功" aria-hidden="true" class="header-anchor">#</a> 验证是否安装成功</h4> <ul><li>以交互的方式进入容器</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>docker <span class="token builtin class-name">exec</span> -it zookeeper_zoo1_1 /bin/bash
</code></pre></div><ul><li>使用客户端连接到服务端</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>bash-4.3<span class="token comment"># ./bin/zkCli.sh -server 192.168.75.130:2181</span>
Connecting to <span class="token number">192.168</span>.75.130:2181
<span class="token number">2017</span>-11-09 07:45:58,365 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:zookeeper.version<span class="token operator">=</span><span class="token number">3.4</span>.10-39d3a4f269333c922ed3db283be479f9deacaa0f, built on 03/23/2017 <span class="token number">10</span>:13 GMT
<span class="token number">2017</span>-11-09 07:45:58,374 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:host.name<span class="token operator">=</span>zoo1
<span class="token number">2017</span>-11-09 07:45:58,374 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.version<span class="token operator">=</span><span class="token number">1.8</span>.0_131
<span class="token number">2017</span>-11-09 07:45:58,380 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.vendor<span class="token operator">=</span>Oracle Corporation
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.home<span class="token operator">=</span>/usr/lib/jvm/java-1.8-openjdk/jre
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.class.path<span class="token operator">=</span>/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/build/classes:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/build/lib/*.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/lib/slf4j-log4j12-1.6.1.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/lib/slf4j-api-1.6.1.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/lib/netty-3.10.5.Final.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/lib/log4j-1.2.16.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/lib/jline-0.9.94.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/zookeeper-3.4.10.jar:/zookeeper-3.4.10/bin/<span class="token punctuation">..</span>/src/java/lib/*.jar:/conf:
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.library.path<span class="token operator">=</span>/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64/server:/usr/lib/jvm/java-1.8-openjdk/jre/lib/amd64:/usr/lib/jvm/java-1.8-openjdk/jre/<span class="token punctuation">..</span>/lib/amd64:/usr/java/packages/lib/amd64:/usr/lib64:/lib64:/lib:/usr/lib
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.io.tmpdir<span class="token operator">=</span>/tmp
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:java.compiler<span class="token operator">=</span><span class="token operator">&lt;</span>NA<span class="token operator">&gt;</span>
<span class="token number">2017</span>-11-09 07:45:58,381 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:os.name<span class="token operator">=</span>Linux
<span class="token number">2017</span>-11-09 07:45:58,382 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:os.arch<span class="token operator">=</span>amd64
<span class="token number">2017</span>-11-09 07:45:58,382 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:os.version<span class="token operator">=</span><span class="token number">4.4</span>.0-98-generic
<span class="token number">2017</span>-11-09 07:45:58,386 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:user.name<span class="token operator">=</span>root
<span class="token number">2017</span>-11-09 07:45:58,386 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:user.home<span class="token operator">=</span>/root
<span class="token number">2017</span>-11-09 07:45:58,386 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:Environment@100<span class="token punctuation">]</span> - Client environment:user.dir<span class="token operator">=</span>/zookeeper-3.4.10
<span class="token number">2017</span>-11-09 07:45:58,389 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main:ZooKeeper@438<span class="token punctuation">]</span> - Initiating client connection, <span class="token assign-left variable">connectString</span><span class="token operator">=</span><span class="token number">192.168</span>.75.130:2181 <span class="token assign-left variable">sessionTimeout</span><span class="token operator">=</span><span class="token number">30000</span> <span class="token assign-left variable">watcher</span><span class="token operator">=</span>org.apache.zookeeper.ZooKeeperMain<span class="token variable">$MyWatcher</span>@3eb07fd3
<span class="token number">2017</span>-11-09 07:45:58,428 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.75.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1032<span class="token punctuation">]</span> - Opening socket connection to server <span class="token number">192.168</span>.75.130/192.168.75.130:2181. Will not attempt to authenticate using SASL <span class="token punctuation">(</span>unknown error<span class="token punctuation">)</span>
Welcome to ZooKeeper<span class="token operator">!</span>
JLine support is enabled
<span class="token number">2017</span>-11-09 07:45:58,529 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.75.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@876<span class="token punctuation">]</span> - Socket connection established to <span class="token number">192.168</span>.75.130/192.168.75.130:2181, initiating session
<span class="token punctuation">[</span>zk: <span class="token number">192.168</span>.75.130:2181<span class="token punctuation">(</span>CONNECTING<span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token number">2017</span>-11-09 07:45:58,573 <span class="token punctuation">[</span>myid:<span class="token punctuation">]</span> - INFO  <span class="token punctuation">[</span>main-SendThread<span class="token punctuation">(</span><span class="token number">192.168</span>.75.130:2181<span class="token punctuation">)</span>:ClientCnxn<span class="token variable">$SendThread</span>@1299<span class="token punctuation">]</span> - Session establishment complete on server <span class="token number">192.168</span>.75.130/192.168.75.130:2181, sessionid <span class="token operator">=</span> 0x15f9fbc12ec0000, negotiated <span class="token function">timeout</span> <span class="token operator">=</span> <span class="token number">30000</span>

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
</code></pre></div><ul><li>使用服务端工具检查服务器状态</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: standalone
</code></pre></div><h3 id="集群模式"><a href="#集群模式" aria-hidden="true" class="header-anchor">#</a> 集群模式</h3> <h4 id="第一台主机"><a href="#第一台主机" aria-hidden="true" class="header-anchor">#</a> 第一台主机</h4> <h4 id="docker-compose-yml-2"><a href="#docker-compose-yml-2" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>version: <span class="token string">'3.1'</span>
services:
    zoo1:
        image: zookeeper
        restart: always
        environment:
            ZOO_MY_ID: <span class="token number">1</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span><span class="token number">192.168</span>.75.130:2888:3888 server.2<span class="token operator">=</span><span class="token number">192.168</span>.75.134:2888:3888 server.3<span class="token operator">=</span><span class="token number">192.168</span>.75.135:2888:3888
        network_mode: <span class="token function">host</span>
</code></pre></div><h4 id="验证测试"><a href="#验证测试" aria-hidden="true" class="header-anchor">#</a> 验证测试</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>root@UbuntuBase:/usr/local/docker/zookeeper<span class="token comment"># docker exec -it zookeeper_zoo1_1 /bin/bash</span>
bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: leader
</code></pre></div><h4 id="第二台主机"><a href="#第二台主机" aria-hidden="true" class="header-anchor">#</a> 第二台主机</h4> <h4 id="docker-compose-yml-3"><a href="#docker-compose-yml-3" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>
version: <span class="token string">'3.1'</span>
services:
    zoo2:
        image: zookeeper
        restart: always
        environment:
            ZOO_MY_ID: <span class="token number">2</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span><span class="token number">192.168</span>.75.130:2888:3888 server.2<span class="token operator">=</span><span class="token number">192.168</span>.75.134:2888:3888 server.3<span class="token operator">=</span><span class="token number">192.168</span>.75.135:2888:3888
        network_mode: <span class="token function">host</span>
</code></pre></div><h4 id="验证测试-2"><a href="#验证测试-2" aria-hidden="true" class="header-anchor">#</a> 验证测试</h4> <p>root@UbuntuBase:/usr/local/docker/zookeeper# docker exec -it zookeeper_zoo2_1 /bin/bash
bash-4.3# ./bin/zkServer.sh status
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower</p> <h4 id="第三台主机"><a href="#第三台主机" aria-hidden="true" class="header-anchor">#</a> 第三台主机</h4> <h4 id="docker-compose-yml-4"><a href="#docker-compose-yml-4" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>version: <span class="token string">'3.1'</span>
services:
    zoo3:
        image: zookeeper
        restart: always
        environment:
            ZOO_MY_ID: <span class="token number">3</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span><span class="token number">192.168</span>.75.130:2888:3888 server.2<span class="token operator">=</span><span class="token number">192.168</span>.75.134:2888:3888 server.3<span class="token operator">=</span><span class="token number">192.168</span>.75.135:2888:3888
        network_mode: <span class="token function">host</span>
</code></pre></div><h4 id="验证测试-3"><a href="#验证测试-3" aria-hidden="true" class="header-anchor">#</a> 验证测试</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>root@UbuntuBase:/usr/local/docker/zookeeper<span class="token comment"># docker exec -it zookeeper_zoo3_1 /bin/bash</span>
bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower
</code></pre></div><p>伪集群模式</p> <h1 id="docker-compose-yml-5"><a href="#docker-compose-yml-5" aria-hidden="true" class="header-anchor">#</a> docker-compose.yml</h1> <div class="language-sh extra-class"><pre class="language-sh"><code>version: <span class="token string">'3.1'</span>
services:
    zoo1:
        image: zookeeper
        restart: always
        hostname: zoo1
        ports:
            - <span class="token number">2181</span>:2181
        environment:
            ZOO_MY_ID: <span class="token number">1</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span>zoo1:2888:3888 server.2<span class="token operator">=</span>zoo2:2888:3888 server.3<span class="token operator">=</span>zoo3:2888:3888

    zoo2:
        image: zookeeper
        restart: always
        hostname: zoo2
        ports:
            - <span class="token number">2182</span>:2181
        environment:
            ZOO_MY_ID: <span class="token number">2</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span>zoo1:2888:3888 server.2<span class="token operator">=</span>zoo2:2888:3888 server.3<span class="token operator">=</span>zoo3:2888:3888

    zoo3:
        image: zookeeper
        restart: always
        hostname: zoo3
        ports:
            - <span class="token number">2183</span>:2181
        environment:
            ZOO_MY_ID: <span class="token number">3</span>
            ZOO_SERVERS: server.1<span class="token operator">=</span>zoo1:2888:3888 server.2<span class="token operator">=</span>zoo2:2888:3888 server.3<span class="token operator">=</span>zoo3:2888:3888
</code></pre></div><h4 id="验证是否安装成功-2"><a href="#验证是否安装成功-2" aria-hidden="true" class="header-anchor">#</a> 验证是否安装成功</h4> <ul><li>分别以交互方式进入容器查看</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>docker <span class="token builtin class-name">exec</span> -it zookeeper_zoo1_1 /bin/bash
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>docker <span class="token builtin class-name">exec</span> -it zookeeper_zoo2_1 /bin/bash
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>docker <span class="token builtin class-name">exec</span> -it zookeeper_zoo3_1 /bin/bash
</code></pre></div><ul><li>使用服务端工具检查服务器状态</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>root@UbuntuBase:/usr/local/docker/zookeeper<span class="token comment"># docker exec -it zookeeper_zoo1_1 /bin/bash</span>
bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>root@UbuntuBase:/usr/local/docker/zookeeper<span class="token comment"># docker exec -it zookeeper_zoo2_1 /bin/bash</span>
bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: follower
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code>root@UbuntuBase:/usr/local/docker/zookeeper<span class="token comment"># docker exec -it zookeeper_zoo3_1 /bin/bash</span>
bash-4.3<span class="token comment"># ./bin/zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /conf/zoo.cfg
Mode: leader
</code></pre></div><p>从上面的验证结果可以看出：zoo1 为跟随者，zoo2 为跟随者，zoo3 为领导者</p> <h2 id="附：linux-下手动安装-zookeeper"><a href="#附：linux-下手动安装-zookeeper" aria-hidden="true" class="header-anchor">#</a> 附：Linux 下手动安装 Zookeeper</h2> <p>Zookeeper 部署有三种方式，单机模式、集群模式、伪集群模式，以下采用手动安装的方式部署</p> <p><strong>注意：</strong> 集群为大于等于3个奇数，如 3、5、7,不宜太多，集群机器多了选举和数据同步耗时长，不稳定。</p> <p>单机模式</p> <h4 id="下载"><a href="#下载" aria-hidden="true" class="header-anchor">#</a> 下载</h4> <p>进入要下载的版本的目录，选择 <code>.tar.gz</code> 文件下载，下载链接：http://archive.apache.org/dist/zookeeper/</p> <p>####安装
注意： 需要先安装 <code>Java</code></p> <p>使用 tar 解压要安装的目录即可，以 3.4.13 版本为例，解压到 <code> /usr/local/zookeeper-3.4.13</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">tar</span> -zxvf zookeeper-3.4.13.tar.gz -C /usr/local
</code></pre></div><h4 id="配置"><a href="#配置" aria-hidden="true" class="header-anchor">#</a> 配置</h4> <p>在根目录下创建 data 和 logs 两个目录用于存储数据和日志</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /usr/local/zookeeper-3.4.13
<span class="token function">mkdir</span> data
<span class="token function">mkdir</span> logs
</code></pre></div><p>在 conf 目录下新建 zoo.cfg 文件，写入以下内容保存</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper-3.4.13/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/usr/local/zookeeper-3.4.13/logs
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
</code></pre></div><h4 id="启动和停止"><a href="#启动和停止" aria-hidden="true" class="header-anchor">#</a> 启动和停止</h4> <p>进入 bin 目录，启动、停止、重启和查看当前节点状态</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkServer.sh start
./zkServer.sh stop
./zkServer.sh restart
./zkServer.sh status
</code></pre></div><h3 id="伪集群模式"><a href="#伪集群模式" aria-hidden="true" class="header-anchor">#</a> 伪集群模式</h3> <p>伪集群模式就是在同一主机启动多个 zookeeper 并组成集群，下边以在 192.168.10.134 主机上创 3 个 zookeeper 组集群为例。</p> <p>将通过单机模式安装的 zookeeper，复制成 zookeeper1/zookeeper2/zookeeper3 三份</p> <h4 id="zookeeper1"><a href="#zookeeper1" aria-hidden="true" class="header-anchor">#</a> zookeeper1</h4> <p>修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper1/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/usr/local/zookeeper1/logs
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">2</span>
server.1<span class="token operator">=</span><span class="token number">192.168</span>.10.134:2888:3888
server.2<span class="token operator">=</span><span class="token number">192.168</span>.10.134:4888:5888
server.3<span class="token operator">=</span><span class="token number">192.168</span>.10.134:6888:7888
</code></pre></div><p>设置服务器 ID
echo '1' &gt; data/myid</p> <h4 id="zookeeper2"><a href="#zookeeper2" aria-hidden="true" class="header-anchor">#</a> zookeeper2</h4> <p>修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper2/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/usr/local/zookeeper2/logs
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">2</span>
server.1<span class="token operator">=</span><span class="token number">192.168</span>.10.134:2888:3888
server.2<span class="token operator">=</span><span class="token number">192.168</span>.10.134:4888:5888
server.3<span class="token operator">=</span><span class="token number">192.168</span>.10.134:6888:7888
</code></pre></div><p>设置服务器 ID</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">'2'</span> <span class="token operator">&gt;</span> data/myid
</code></pre></div><h4 id="zookeeper3"><a href="#zookeeper3" aria-hidden="true" class="header-anchor">#</a> zookeeper3</h4> <p>修改配置文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/usr/local/zookeeper3/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/usr/local/zookeeper3/logs
<span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">2</span>
server.1<span class="token operator">=</span><span class="token number">192.168</span>.10.134:2888:3888
server.2<span class="token operator">=</span><span class="token number">192.168</span>.10.134:4888:5888
server.3<span class="token operator">=</span><span class="token number">192.168</span>.10.134:6888:7888
</code></pre></div><p>设置服务器 ID</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> <span class="token string">'3'</span> <span class="token operator">&gt;</span> data/myid
</code></pre></div><h3 id="启动和停止-2"><a href="#启动和停止-2" aria-hidden="true" class="header-anchor">#</a> 启动和停止</h3> <p>分别启动服务器，顺序无所谓</p> <div class="language-sh extra-class"><pre class="language-sh"><code>
./zkServer.sh start
./zkServer.sh stop
./zkServer.sh restart
./zkServer.sh status
</code></pre></div><h3 id="集群模式-2"><a href="#集群模式-2" aria-hidden="true" class="header-anchor">#</a> 集群模式</h3> <p>集群模式就是在不同主机上安装 zookeeper 然后组成集群的模式，操作步骤同上，此处不再赘述</p> <h2 id="zookeeper-配置说明"><a href="#zookeeper-配置说明" aria-hidden="true" class="header-anchor">#</a> Zookeeper 配置说明</h2> <h3 id="zookeeper-的三种工作模式"><a href="#zookeeper-的三种工作模式" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的三种工作模式</h3> <ul><li>单机模式：存在单点故障</li> <li>集群模式：在多台机器上部署 Zookeeper 集群，适合线上环境使用。</li> <li>伪集群模式：在一台机器同时运行多个 Zookeeper 实例，仍然有单点故障问题，当然，其中配置的端口号要错开的，适合实验环境模拟集群使用。</li></ul> <h3 id="zookeeper-的三种端口号"><a href="#zookeeper-的三种端口号" aria-hidden="true" class="header-anchor">#</a> Zookeeper 的三种端口号</h3> <ul><li>2181：客户端连接 Zookeeper 集群使用的监听端口号</li> <li>3888：选举 leader 使用</li> <li>2888：集群内机器通讯使用（Leader 和 Follower 之间数据同步使用的端口号，Leader 监听此端口）</li></ul> <h3 id="zookeeper-单机模式配置文件"><a href="#zookeeper-单机模式配置文件" aria-hidden="true" class="header-anchor">#</a> Zookeeper 单机模式配置文件</h3> <p>配置文件路径：<code>/conf/zoo.cfg</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/datalog
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
</code></pre></div><ul><li>clientPort：这个端口就是客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求。</li> <li>dataDir：Zookeeper 保存数据的目录。</li> <li>dataLogDir：Zookeeper 保存日志的目录。</li> <li>tickTime：这个时间是作为 Zookeeper 服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每隔 tickTime 时间就会发送一个心跳。</li></ul> <h3 id="zookeeper-集群模式配置文件"><a href="#zookeeper-集群模式配置文件" aria-hidden="true" class="header-anchor">#</a> Zookeeper 集群模式配置文件</h3> <p>配置文件路径：<code>/conf/zoo.cfg</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token assign-left variable">clientPort</span><span class="token operator">=</span><span class="token number">2181</span>
<span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/data
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/datalog
<span class="token assign-left variable">tickTime</span><span class="token operator">=</span><span class="token number">2000</span>
<span class="token assign-left variable">initLimit</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">syncLimit</span><span class="token operator">=</span><span class="token number">2</span>
autopurge.snapRetainCount<span class="token operator">=</span><span class="token number">3</span>
autopurge.purgeInterval<span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">maxClientCnxns</span><span class="token operator">=</span><span class="token number">60</span>
server.1<span class="token operator">=</span><span class="token number">192.168</span>.0.1:2888:3888
server.2<span class="token operator">=</span><span class="token number">192.168</span>.0.2:2888:3888
server.3<span class="token operator">=</span><span class="token number">192.168</span>.0.3:2888:3888
</code></pre></div><ul><li>initLimit：配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 initLimit（默认为 10） 个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5 * 2000 = 10 秒</li> <li>syncLimit：配置 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 2 * 2000 = 4 秒</li> <li>定时清理（Zookeeper 从 3.4.0 开始提供了自动清理快照和事务日志的功能）以下两个参数配合使用：
<ul><li>autopurge.purgeInterval：指定了清理频率，单位是小时，需要填写一个 1 或更大的整数，默认是 0，表示不开启自己清理功能。</li> <li>autopurge.snapRetainCount：指定了需要保留的文件数目。默认是保留 3 个。</li></ul></li> <li>maxClientCnxns：限制连接到 Zookeeper 的客户端的数量，限制并发连接的数量，它通过 IP 来区分不同的客户端。此配置选项可以用来阻止某些类别的 Dos 攻击。将它设置为 0 或者忽略而不进行设置将会取消对并发连接的限制。</li> <li>server.A=B：C：D：其中 A 是一个数字，表示这个是第几号服务器。B 是这个服务器的 IP 地址。C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口(2888)；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口(3888)。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。
注意： server.A 中的 A 是在 dataDir 配置的目录中创建一个名为 myid 的文件里的值（如：1）</li></ul> <h4 id="zookeeper-常用命令"><a href="#zookeeper-常用命令" aria-hidden="true" class="header-anchor">#</a> Zookeeper 常用命令</h4> <h4 id="zkserver"><a href="#zkserver" aria-hidden="true" class="header-anchor">#</a> zkServer</h4> <p>启动服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkServer.sh start
</code></pre></div><p>停止服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkServer.sh stop
</code></pre></div><p>重启服务</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkServer.sh restart
</code></pre></div><p>执行状态</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkServer.sh status
</code></pre></div><h4 id="zkclient"><a href="#zkclient" aria-hidden="true" class="header-anchor">#</a> zkClient</h4> <p>客户端连接服务器并进入 Bash 模式</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./zkCli.sh -server <span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>
</code></pre></div><h4 id="命令参数"><a href="#命令参数" aria-hidden="true" class="header-anchor">#</a> 命令参数</h4> <div class="language-sh extra-class"><pre class="language-sh"><code>ZooKeeper -server host:port cmd args
	<span class="token function">stat</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>
	<span class="token builtin class-name">set</span> path data <span class="token punctuation">[</span>version<span class="token punctuation">]</span>
	<span class="token function">ls</span> path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>
	delquota <span class="token punctuation">[</span>-n<span class="token operator">|</span>-b<span class="token punctuation">]</span> path
	ls2 path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>
	setAcl path acl
	setquota -n<span class="token operator">|</span>-b val path
	<span class="token function">history</span> 
	redo cmdno
	printwatches on<span class="token operator">|</span>off
	delete path <span class="token punctuation">[</span>version<span class="token punctuation">]</span>
	<span class="token function">sync</span> path
	listquota path
	rmr path
	get path <span class="token punctuation">[</span>watch<span class="token punctuation">]</span>
	create <span class="token punctuation">[</span>-s<span class="token punctuation">]</span> <span class="token punctuation">[</span>-e<span class="token punctuation">]</span> path data acl
	addauth scheme auth
	quit 
	getAcl path
	close 
	connect host:port
</code></pre></div><ul><li>创建节点（Bash 模式）</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>create /test <span class="token string">&quot;hello zookeeper&quot;</span>
</code></pre></div><ul><li>查询节点（Bash 模式）</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>get /test

<span class="token comment">#### 输出如下</span>
Hello Zookeeper
cZxid <span class="token operator">=</span> 0x100000004
ctime <span class="token operator">=</span> Fri Oct <span class="token number">19</span> 05:11:47 GMT <span class="token number">2018</span>
mZxid <span class="token operator">=</span> 0x100000004
mtime <span class="token operator">=</span> Fri Oct <span class="token number">19</span> 05:11:47 GMT <span class="token number">2018</span>
pZxid <span class="token operator">=</span> 0x100000004
cversion <span class="token operator">=</span> <span class="token number">0</span>
dataVersion <span class="token operator">=</span> <span class="token number">0</span>
aclVersion <span class="token operator">=</span> <span class="token number">0</span>
ephemeralOwner <span class="token operator">=</span> 0x0
dataLength <span class="token operator">=</span> <span class="token number">15</span>
numChildren <span class="token operator">=</span> <span class="token number">0</span>
</code></pre></div><ul><li>删除节点（Bash 模式）</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code>delete
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a8d644b6.js" defer></script><script src="/assets/js/2.b0571e25.js" defer></script><script src="/assets/js/113.b8841596.js" defer></script>
  </body>
</html>
